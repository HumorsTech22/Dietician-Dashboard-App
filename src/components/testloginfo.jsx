// "use client"
// import { useState } from 'react';
// import { toast } from 'sonner';
// import { submitPlanSummaryService } from '../services/authService';

// export default function TestLogInfo({ onConfirmNext }){
//     const [testsAllotted, setTestsAllotted] = useState('');
//     const [testRemaining, setTestRemaining] = useState(10000);
//     const [isLoading, setIsLoading] = useState(false);
//     const [apiResponse, setApiResponse] = useState(null); // Store API response
// console.log("apiResponse11:-", apiResponse);
//     const handleTestsAllottedChange = (e) => {
//         const value = e.target.value;
//         setTestsAllotted(value);

//         // If user enters a number, subtract from 10000
//         if (value && !isNaN(value)) {
//             const allotted = parseInt(value) || 0;
//             const remaining = 10000 - allotted;
//             setTestRemaining(remaining >= 0 ? remaining : 0);
//         } else {
//             // If input is empty or not a number, reset to 10000
//             setTestRemaining(10000);
//         }
//     };

//     const validateForm = () => {
//         if (!testsAllotted.trim()) {
//             toast.error('Please enter number of tests assigned');
//             return false;
//         }
//         if (isNaN(testsAllotted) || parseInt(testsAllotted) <= 0) {
//             toast.error('Please enter a valid number for tests assigned');
//             return false;
//         }
//         return true;
//     };

//     const saveToLocalStorage = (isDraft = false) => {
//         if (!isDraft && !validateForm()) {
//             return;
//         }

//         // Get existing planSummary from localStorage
//         const existingData = localStorage.getItem('planSummary');
//         let planSummary = existingData ? JSON.parse(existingData) : {};

//         // Update with test log info
//         planSummary = {
//             ...planSummary,
//             test_no_assigned: parseInt(testsAllotted) || 0
//         };

//         // Add draft flag if saving as draft
//         if (isDraft) {
//             planSummary.isDraft = true;
//         }

//         // Save back to localStorage
//         localStorage.setItem('planSummary', JSON.stringify(planSummary));

//         if (isDraft) {
//             toast.success('Test log info saved as draft successfully!');
//         } else {
//             toast.success('Test log info saved successfully!');
//         }
//     };

//     const handleSaveAsDraft = () => {
//         saveToLocalStorage(true);
//     };

//     const submitPlanSummary = async () => {
//         if (!validateForm()) {
//             return;
//         }

//         setIsLoading(true);
//         try {
//             // Get data from localStorage
//             const planSummaryData = localStorage.getItem('planSummary');
//             if (!planSummaryData) {
//                 toast.error('No plan summary data found');
//                 return;
//             }

//             const planSummary = JSON.parse(planSummaryData);

//             // Get dietitian_id and client_id from URL
//             const urlParams = new URLSearchParams(window.location.search);
//             const dietitianId = urlParams.get('dietician_id');
//             const clientId = urlParams.get('profile_id');
//             console.log('URL Parameters:', {
//                 dietitian_id: dietitianId,
//                 client_id: clientId,
//             });

//             if (!dietitianId || !clientId) {
//                 toast.error('Missing dietitian ID or client ID in URL');
//                 return;
//             }

//             // Prepare the API request body
//             const requestBody = {
//                 dietitian_id: dietitianId,
//                 client_id: clientId,
//                 plan_title: planSummary.plan_title || "",
//                 plan_start_date: planSummary.plan_start_date || "",
//                 plan_end_date: planSummary.plan_end_date || "",
//                 calories_target: planSummary.calories_target || 0,
//                 protein_target: planSummary.protein_target || 0,
//                 fiber_target: planSummary.fiber_target || 0,
//                 water_target: planSummary.water_target || 0,
//                 test_no_assigned: parseInt(testsAllotted) || 0,
//                 goal: planSummary.goal || [],
//                 approach: planSummary.approach || "",
//                 status: "active"
//             };

//             // Make API call using the service and store response in variable
//             const apiResponse = await submitPlanSummaryService(requestBody);
//             console.log("API Response:", apiResponse);

//             // Store the response in state
//             setApiResponse(apiResponse);

//             if (apiResponse.status) {
//                 toast.success('Plan summary submitted successfully!');
//                 onConfirmNext?.();
//             } else {
//                 toast.error(apiResponse.message || 'Failed to submit plan summary');
//             }

//         } catch (error) {
//             console.error('API Error:', error);
//             toast.error(error.message || 'Failed to submit plan summary');
//         } finally {
//             setIsLoading(false);
//         }
//     };

//     const handleConfirmNext = () => {
//         // First save to localStorage
//         saveToLocalStorage(false);
//         // Then submit to API
//         submitPlanSummary();
//     };

//     return(
//         <>
//          <div className='flex-1 flex-col gap-[310px] h-full'>

//             <div className='pt-[23px] pb-[18px] '>
//               <p className='text-[#252525] pb-[18px] pt-[23px] text-[20px] font-semibold leading-[110%] tracking-[0.4px] whitespace-nowrap'>Test log info</p>

//               <div className="w-full  border-b border-[#E1E6ED]"></div>

//               <div className='mt-[15px]'>
//                 <div className="flex gap-5 items-end">
//                   <div className="relative flex-1">
//                     <input 
//                       type="text" 
//                       id="tests_allotted"
//                       value={testsAllotted}
//                       onChange={handleTestsAllottedChange}
//                       className="block py-[15px] pl-[19px] pr-[13px] w-full text-[14px] text-[#252525] bg-white rounded-[8px] border border-[#E1E6ED] appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" 
//                       placeholder=" " 
//                     />
//                     <label htmlFor="tests_allotted" className="absolute text-[14px] text-[#9CA3AF] dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white dark:bg-gray-900 px-2 peer-focus:px-2 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto start-1">
//                       Tests assigned
//                     </label>
//                   </div>

//                   <div className="relative flex-1">
//                     <input 
//                       type="text" 
//                       id="test_remaining"
//                       value={testRemaining}
//                       readOnly
//                       className="block py-[15px] pl-[19px] pr-[13px] w-full text-[14px] text-[#252525] bg-white rounded-[8px] border border-[#E1E6ED] appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" 
//                       placeholder=" " 
//                     />
//                     <label htmlFor="test_remaining" className="absolute text-[14px] text-[#9CA3AF] dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white dark:bg-gray-900 px-2 peer-focus:px-2 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto start-1">
//                       Test remaining
//                     </label>
//                   </div>
//                 </div>
//               </div>
//             </div>

//             <div>
//               <div className="w-full border-b border-[#E1E6ED] mt-[30px]"></div>

//               <div className='py-[23px]'>
//                 <div className='flex gap-5 justify-end'>
//                   <div 
//                     className='px-5 py-[15px] bg-white border border-[#D9D9D9] rounded-[10px] cursor-pointer'
//                     onClick={handleSaveAsDraft}
//                   >
//                     <span className='text-[#308BF9] text-[12px] font-semibold leading-normal tracking-[-0.24px]'>Save as draft</span>
//                   </div>

//                   <div 
//                     className='px-5 py-[15px] bg-[#308BF9] rounded-[10px] cursor-pointer flex items-center justify-center'
//                     onClick={handleConfirmNext}
//                     disabled={isLoading}
//                   >
//                     <span className='text-white text-[12px] font-semibold leading-normal tracking-[-0.24px]'>
//                       {isLoading ? 'Submitting...' : 'Confirm & Next'}
//                     </span>
//                   </div>
//                 </div>
//               </div>
//             </div>

//           </div>
//         </>
//     )
// };



"use client";

import { useState, useRef, useEffect } from "react";

import { toast } from "sonner";
import {
  submitPlanSummaryService,
  fetchTestRemaining,
} from "../services/authService";
import { setExtractedData } from "@/store/extractedDataSlice";
import { cookieManager } from "../lib/cookies";
import { useDispatch, useSelector } from "react-redux";
import { setIsExtracting } from "@/store/extractionSlice";

export default function TestLogInfo({ onConfirmNext }) {
  const [testsAllotted, setTestsAllotted] = useState(""); // for payload
  const [planDays, setPlanDays] = useState("");           // shown in "No of Tests allotted"
  const [baseRemaining, setBaseRemaining] = useState(0);  // API remaining
  const [testRemaining, setTestRemaining] = useState(0);  // finalRemaining = baseRemaining - planDays
  
  // NEW: Separate variable to store the subtraction result
  const [subtractionResult, setSubtractionResult] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  //const [isExtracting, setIsExtracting] = useState(false);
  const isExtracting = useSelector((state) => state.extraction.isExtracting);
  const [apiResponse, setApiResponse] = useState(null);

  const [progress, setProgress] = useState(0);
  const rafRef = useRef(null);
  const startTimeRef = useRef(0);
  const targetMsRef = useRef(0);
  const capRef = useRef(0);
  const runningRef = useRef(false);

  const [errors, setErrors] = useState({ testsAllotted: "" });

  const dispatch = useDispatch();

  // ========= 1) Fetch remaining from TESTREMAINING API =========
  useEffect(() => {
    const fetchRemainingFromApi = async () => {
      try {
        const dieticianCookie = cookieManager.getJSON("dietician");
        const dietitianId = dieticianCookie?.dietician_id;

        if (!dietitianId) {
          console.warn("No dietitian_id in cookie");
          return;
        }

        const resp = await fetchTestRemaining(dietitianId);

        if (resp?.success) {
          const remainingFromApi = parseInt(resp.remaining, 10) || 0;
          setBaseRemaining(remainingFromApi);
          setTestRemaining(remainingFromApi); // initial, before subtracting
        } else {
          setBaseRemaining(0);
          setTestRemaining(0);
        }
      } catch (err) {
        console.error("Error fetching remaining tests:", err);
      }
    };

    fetchRemainingFromApi();
  }, []);

  // ========= 2) Helpers =========

  const calculatePlanDays = (startDate, endDate) => {
    if (!startDate || !endDate) return "";

    const start = new Date(startDate);
    const end = new Date(endDate);

    if (isNaN(start.getTime()) || isNaN(end.getTime())) return "";

    const timeDiff = end.getTime() - start.getTime();
    const daysDiff =
      Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // include both start & end

    return daysDiff > 0 ? `${daysDiff}` : "";
  };

  const loadFromLocalStorage = () => {
    try {
      const savedData = localStorage.getItem("planSummary");
      if (savedData) {
        const data = JSON.parse(savedData);

        // If tests already stored earlier
        if (data.test_no_assigned) {
          setTestsAllotted(String(data.test_no_assigned));
        }

        if (data.plan_start_date && data.plan_end_date) {
          const calculatedDays = calculatePlanDays(
            data.plan_start_date,
            data.plan_end_date
          );
          setPlanDays(calculatedDays || "");
        }
      }
    } catch (error) {
      console.error("Error loading from localStorage:", error);
    }
  };

  useEffect(() => {
    loadFromLocalStorage();
  }, []);

  // ========= 3) Subtraction logic (CORE) - MODIFIED =========
  useEffect(() => {
    const allotted = parseInt(planDays, 10) || 0;
    const remaining = parseInt(baseRemaining, 10) || 0;


    // sync testsAllotted with planDays (for submit)
    setTestsAllotted(allotted ? String(allotted) : "");

    const finalRemaining = remaining - allotted;

    // Store in both variables
    const result = finalRemaining >= 0 ? finalRemaining : 0;
    setTestRemaining(result);
    setSubtractionResult(result); // NEW: Store in separate variable
  
  }, [planDays, baseRemaining]);

  // Rest of your code remains the same...
  const startProgress = (targetMs = 300000, cap = 98) => {
    cancelProgress();
    startTimeRef.current = Date.now();
    targetMsRef.current = targetMs;
    capRef.current = Math.min(99, Math.max(50, cap));
    runningRef.current = true;
    setProgress(0);

    const tick = () => {
      if (!runningRef.current) return;
      const elapsed = Date.now() - startTimeRef.current;
      const pct = Math.min(
        capRef.current,
        Math.floor((elapsed / targetMsRef.current) * capRef.current)
      );
      setProgress(pct);
      rafRef.current = requestAnimationFrame(tick);
    };
    rafRef.current = requestAnimationFrame(tick);
  };

  const completeProgress = () => {
    runningRef.current = false;
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    setProgress(100);
  };

  const resetProgress = () => {
    runningRef.current = false;
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    setProgress(0);
  };

  const cancelProgress = () => {
    runningRef.current = false;
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
  };

  // ========= 5) Cookie Reader for submit =========
  function getCookie(name) {
    const m = document.cookie.match(
      new RegExp(
        "(?:^|; )" + name.replace(/([$?*|{}\\^])/g, "\\$1") + "=([^;]*)"
      )
    );
    return m ? decodeURIComponent(m[1]) : "";
  }

  // ========= 6) Validation / Save =========
  const validateForm = () => {
    let ok = true;
    const next = { testsAllotted: "" };

    if (!testsAllotted || testsAllotted.toString().trim() === "") {
      next.testsAllotted = "Enter tests assigned";
      ok = false;
    } else if (isNaN(testsAllotted) || parseInt(testsAllotted, 10) <= 0) {
      next.testsAllotted = "Enter a valid positive number";
      ok = false;
    }

    setErrors(next);
    if (!ok) toast.error("Please fix the highlighted fields");
    return ok;
  };

  const saveToLocalStorage = (isDraft = false) => {
    if (!isDraft && !validateForm()) return;
    const existingData = localStorage.getItem("planSummary");
    let planSummary = existingData ? JSON.parse(existingData) : {};
    planSummary = {
      ...planSummary,
      test_no_assigned: parseInt(testsAllotted, 10) || 0,
    };
    if (isDraft) planSummary.isDraft = true;
    localStorage.setItem("planSummary", JSON.stringify(planSummary));
  };

  const handleSaveAsDraft = () => saveToLocalStorage(true);

  // ========= 7) Extract Diet PDF =========
  const extractDietPdf = async ({ dieticianId, clientId, dietplanId }) => {
    const savedPdf = localStorage.getItem("uploadedPdfFile");

    if (!savedPdf) {
      toast.error("No PDF found. Please upload a file first.");
      return false;
    }

    try {
    dispatch(setIsExtracting(true)); 
      toast.message("Extracting PDF…");
      startProgress(300000, 98);

      const pdfData = JSON.parse(savedPdf);

      let pdfFile;

      if (pdfData.data && pdfData.data.startsWith("data:application/pdf")) {
        const response = await fetch(pdfData.data);
        const blob = await response.blob();
        pdfFile = new File([blob], pdfData.name || "diet_plan.pdf", {
          type: "application/pdf",
        });
  
      } else if (pdfData.blobUrl) {
        try {
          const response = await fetch(pdfData.blobUrl);
          if (!response.ok) {
            throw new Error(
              `Blob URL fetch failed with status: ${response.status}`
            );
          }
          const blob = await response.blob();
          pdfFile = new File([blob], pdfData.name || "diet_plan.pdf", {
            type: "application/pdf",
          });

        } catch (blobError) {
          console.error("Blob URL failed:", blobError);
          throw new Error(
            "Blob URL is no longer valid. Please re-upload the PDF file."
          );
        }
      } else {
        throw new Error(
          "No valid PDF data found in storage. Please re-upload the PDF file."
        );
      }

      if (!pdfFile || pdfFile.size === 0) {
        throw new Error("Created PDF file is empty or invalid");
      }


      const formData = new FormData();
      formData.append("file", pdfFile);
      formData.append("login_id", dieticianId || "");
      formData.append("profile_id", clientId || "");
      formData.append("dietplan_id", dietplanId || "");

      for (let [key, value] of formData.entries()) {
        console.log(`FormData: ${key} =`, value);
      }

      const res = await fetch("https://respyr.in/mini/api/extract", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(
          `Extractor error (${res.status}): ${txt || "Failed to extract"}`
        );
      }

      const json = await res.json();
      dispatch(setExtractedData(json));

      completeProgress();
      toast.success("PDF extracted successfully.");
      return true;
    } catch (err) {
      console.error("Extractor Error:", err);
      toast.error(err.message || "Failed to extract PDF");
      resetProgress();
      return false;
    } finally {
       dispatch(setIsExtracting(false)); 
      setTimeout(() => {
        if (!isLoading) resetProgress();
      }, 600);
    }
  };

  // ========= 8) Submit Plan Summary =========
const submitPlanSummary = async () => {
 
  if (!validateForm()) {
    return;
  }

  setIsLoading(true);
  startProgress(8000, 90);

  try {
    const planSummaryData = localStorage.getItem("planSummary");
    if (!planSummaryData) {
      toast.error("No plan summary data found");
      resetProgress();
      return;
    }

    const planSummary = JSON.parse(planSummaryData);
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get("profile_id");
    
    // FIX: Parse the dietician cookie to extract just the ID
    const dieticianCookie = getCookie("dietician");
    
    let effectiveDieticianId = "";
    if (dieticianCookie) {
      try {
        const dieticianData = JSON.parse(dieticianCookie);
        effectiveDieticianId = dieticianData.dietician_id || "";
      } catch (parseError) {
        console.error("Error parsing dietician cookie:", parseError);
      }
    }

    const effectiveClientId = clientId || "";

    if (!effectiveDieticianId || !effectiveClientId) {

      toast.error("Missing dietician ID or client ID (URL/cookie)");
      resetProgress();
      return;
    }

    const requestBody = {
      dietitian_id: effectiveDieticianId, // Now this is just "RespyrD02"
      client_id: effectiveClientId,
      plan_title: planSummary.plan_title || "",
      plan_start_date: planSummary.plan_start_date || "",
      plan_end_date: planSummary.plan_end_date || "",
      calories_target: planSummary.calories_target || 0,
      protein_target: planSummary.protein_target || 0,
      fiber_target: planSummary.fiber_target || 0,
      water_target: planSummary.water_target || 0,
      test_no_assigned: parseInt(testsAllotted, 10) || 0,
      goal: planSummary.goal || [],
      approach: planSummary.approach || "",
      status: "active",
      diet_type: planSummary.diet_type || "", 
      is_diabetic: planSummary.is_diabetic || false, 
      carbs_target: planSummary.carbs_target || 0, 
      fat_target: planSummary.fat_target || 0, 
    };


    const resp = await submitPlanSummaryService(requestBody);
    setApiResponse(resp);

    if (resp?.status) {
      completeProgress();
      toast.success("Plan summary submitted successfully!");

      const dietplanId = resp?.inserted_data?.id || "";

      const extractedOk = await extractDietPdf({
        dieticianId: effectiveDieticianId,
        clientId: effectiveClientId,
        dietplanId,
      });

      if (extractedOk) {
        onConfirmNext?.();
      }
    } else {
      toast.error(resp?.message || "Failed to submit plan summary");
      resetProgress();
    }
  } catch (error) {
    console.error("API Error:", error);
    toast.error(error.message || "Failed to submit plan summary");
    resetProgress();
  } finally {
    setIsLoading(false);
    setTimeout(() => {
      if (!isExtracting) resetProgress();
    }, 600);
  }
};

  const handleConfirmNext = () => {   
      
    const savedPdf = localStorage.getItem("uploadedPdfFile");
    
    if (!savedPdf) {
    
      toast.error("Please upload a PDF file before proceeding.");
      return;
    }

    try {
      const pdfData = JSON.parse(savedPdf);
        
      if (!pdfData.data && !pdfData.blobUrl) {
         
        toast.error("Invalid PDF data. Please re-upload the PDF file.");
        return;
      }
    } catch (error) {
      toast.error("Corrupted PDF data. Please re-upload the PDF file.");
      return;
    }

    saveToLocalStorage(false);
    submitPlanSummary();
  };

  // ========= 9) JSX =========
  return (
    <>
      <div className="flex-1 flex-col gap-[310px] h-full">
        <div className="pt-[23px] pb-[18px] ">
          <div className="flex justify-between items-center">
            <p className="text-[#252525] pb-[18px] pt-[23px] text-[20px] font-semibold leading-[110%] tracking-[0.4px] whitespace-nowrap">
              Test log info
            </p>
          </div>

          <div className="w-full border-b border-[#E1E6ED]"></div>

          <div className="mt-[15px]">
            <div className="flex gap-5 items-end">
              {/* No of Tests allotted (planDays) */}
              <div className="relative flex-1">
                <input
                  type="text"
                  id="plan_days"
                  value={planDays}
                  readOnly
                  className="block py-[15px] pl-[19px] pr-[13px] w-full text-[14px] text-[#252525] bg-white rounded-[8px] border border-[#E1E6ED] focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  placeholder=" "
                />
                <label
                  htmlFor="plan_days"
                  className="absolute text-[14px] text-[#9CA3AF] duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white px-2 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 start-1"
                >
                  No of Tests allotted
                </label>
              </div>

              {/* Test remaining (API remaining − planDays) */}
              <div className="relative hidden">
                <input
                  type="text"
                  id="test_remaining"
                  value={testRemaining}
                  readOnly
                  hidden
                  className="block py-[15px] pl-[19px] pr-[13px] w-full text-[14px] text-[#252525] bg-white rounded-[8px] border border-[#E1E6ED] focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  placeholder=" "
                />
                <label
                  htmlFor="test_remaining"
                  className="absolute text-[14px] text-[#9CA3AF] duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white px-2 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 start-1"
                >
                  Test remaining
                </label>
              </div>



 <div className="relative flex-1">
                <input
                  type="text"
                  id="test_remaining_1"
                  value={subtractionResult}
                  readOnly
                  className="block py-[15px] pl-[19px] pr-[13px] w-full text-[14px] text-[#252525] bg-white rounded-[8px] border border-[#E1E6ED] focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                  placeholder=" "
                />
                <label
                  htmlFor="test_remaining"
                  className="absolute text-[14px] text-[#9CA3AF] duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white px-2 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 start-1"
                >
                  Test remaining
                </label>
              </div>

            </div>

            
          </div>
        </div>

        <div>
          <div className="w-full border-b border-[#E1E6ED] mt-[30px]"></div>

          <div className="py-[23px]">
            <div className="flex gap-5 justify-end">
              <div
                className="px-5 py-[15px] bg-white border border-[#D9D9D9] rounded-[10px] cursor-pointer"
                onClick={handleSaveAsDraft}
              >
                <span className="text-[#308BF9] text-[12px] font-semibold">
                  Save as draft
                </span>
              </div>

              <button
                type="button"
                className="relative px-5 py-[15px] bg-[#308BF9] rounded-[10px] cursor-pointer flex items-center justify-center overflow-hidden disabled:opacity-60 w-[180px]"
                onClick={handleConfirmNext}
                disabled={isLoading || isExtracting}
              >
                {(isLoading || isExtracting) && (
                  <div
                    className="absolute left-0 top-0 h-full bg-[#1D6EDC] transition-all duration-200 ease-out"
                    style={{ width: `${progress}%` }}
                  />
                )}

                <span className="relative text-white text-[12px] font-semibold z-10">
                  {isLoading
                    ? `Submitting ${progress}%`
                    : isExtracting
                    ? `Extracting ${progress}%`
                    : "Confirm & Next"}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}